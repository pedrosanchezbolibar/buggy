<html 
	xmlns:concordion="http://www.concordion.org/2007/concordion" 
	xmlns:ext="urn:concordion-extensions:2010">

	<head>
		<title>Generación de Cres en el alta de una operación FX</title>
		<meta http-equiv="content-type" content="text/html;charset=utf-8"/> 
		<script>
	            function showMessage(elementId) {
		            var x = document.getElementById(elementId);
		            if (x.style.display === "none") {
		                x.style.display = "block";
		            } else {
		                x.style.display = "none";
		            }
	            }
	        </script>
	</head>

	<body>
	
		<h1>Generación de Cres en el alta de una operación FX</h1>
	
		<h2>Descripción</h2>
	
		<p>
			bla bla bla
		</p>
	
	    <h2>Datos de referencia</h2>
	    
	    <p>
	        Insertamos una operación de tipo FX utlizando el template 
	        <span concordion:set="#template">FX.xml</span>
	        y la contrapartida <span concordion:execute="setProperty('CPTY', #TEXT)">NONFINANCIAL_SWIFT_2</span>
	    </p>
	        
	    <p>
	    	<span style="visibility: hidden;" concordion:set="#img" >GeneracionCresFXSpotTrade.png</span>
	        <span ext:embed="getImage(#img)"> </span>
	    </p>
	    <p>
            La External Reference de la operación 
	        <span concordion:echo="#extRef=generateExternalRef()"> </span>  
			<span concordion:execute="setProperty('EXTERNAL_REFERENCE', #extRef)"> </span>
	    </p>	    
	    
        <h2>Proceso de prueba</h2>
        
        <p>
            Insertamos la operación. 
			<span concordion:execute="#ack=insertCDUF(#template)"> </span> 
	   	</p>
<button onclick="showMessage('ack')">Mostrar Ack completo</button>	
<pre concordion:echo="#ack" id="ack" style="display:none"> </pre>	
   	
		<p>
            Comprobamos que se ha insertado correctamente la operación:
        </p>	    			
		
		<table concordion:execute="#trade=getTrade(#ack)">
            <tr>
                <th concordion:echo="#trade.id">Id</th>
				<th concordion:assertEquals="#trade.status">Status</th>
                <th concordion:assertEquals="#trade.productType">Product type</th>
                <th concordion:assertEquals="#trade.counterParty">Counterparty</th>
                <th concordion:assertEquals="#trade.settleDate">Date</th>     
                <th concordion:assertEquals="#trade.quantity">Quantity</th>    
            </tr>
            <tr>
                <td> </td>
                <td>VERIFIED</td>
                <td>FX</td>
                <td>NONFINANCIAL_SWIFT_2</td>
                <td>11/01/2028</td>
                <td>-29751.5200</td>
            </tr>
        </table> 

		<p>
			Esperamos hasta que Calypso genere los Transfers de la operación comprobando que el 
			<span concordion:set="#engine">TransferEngine</span> no tenga eventos pendientes
			(<span concordion:echo="waitForEngine(#engine)"> </span> eventos pendientes).		
		</p>
		
		<p>Las Liquidaciones (Transfers) de este trade son:</p>
		<table concordion:verifyRows="#xfer : getTranfers(#trade)">
			<tr>
				<th concordion:echo="#xfer.id">Transfer Id</th>
				<th concordion:assertEquals="#xfer.eventType">Event Type</th>
				<th concordion:assertEquals="#xfer.status">Status</th>
				<th concordion:assertEquals="#xfer.settlementAmount">Amount</th>
				<th concordion:assertEquals="#xfer.valueDate">Value Date</th>
			</tr>
				<tr>
				<td></td>
				<td>PAYMENT</td>
				<td>VERIFIED</td>
				<td>29751.52</td>
				<td>11/01/2028</td>
			</tr>
			<tr>
				<td></td>
				<td>RECEIPT</td>
				<td>VERIFIED</td>
				<td>26347.95</td>
				<td>11/01/2028</td>
			</tr>
		</table>
        
                    
        <h2>Resultado</h2>
        
		<p>
			Esperamos hasta que Calypso genere los CREs de la operación, comprobando que el <span concordion:set="#engine">CreEngine</span>
			no tenga eventos pendientes(<span concordion:echo="waitForEngine(#engine)"> </span> eventos pendientes).
		</p>
		
		<p>
			Comprobamos que Calypso ha generado todos los Eventos contables correspondientes a su condicion 
			(COTFX, COTFX_REV, CST de sus liquidaciones).
		</p>

		<p>
			Se muestran los Cres en la Tabla ordenados por Effective Date: 
		</p>
		                       
	    <table concordion:verifyRows="#boCre : getCres(#trade)">
	        <tr>
	            <th concordion:assertEquals="#boCre.effectiveDate">Effective Date</th>
	            <th concordion:assertEquals="#boCre.creType">Cre Type</th>
	            <th concordion:assertEquals="#boCre.eventType">Event Type</th>
	            <th concordion:assertEquals="#boCre.originalEventType">Original Event Type</th>
	            <th concordion:assertEquals="getCreAmount(#boCre, '0')">Amount 1</th>
	            <th concordion:assertEquals="getCreAmount(#boCre, '1')">Amount 2</th>
	        </tr>
	        <tr>
	        	<td>09/01/2028</td>
	        	<td>NEW</td>
	        	<td>COTFX</td>
	        	<td>VERIFIED_TRADE</td>
	        	<td>-29751.5200 EUR</td>
	        	<td>26347.9500 GBP</td>
	        </tr>
	        <tr>
	        	<td>11/01/2028</td>
	        	<td>NEW</td>
	        	<td>COTFX_REV</td>
	        	<td>VERIFIED_TRADE</td>
	        	<td>-29751.5200 EUR</td>
	        	<td>26347.9500 GBP</td>
	        </tr>
	        <tr>
	        	<td>11/01/2028</td>
	        	<td>NEW</td>
	        	<td>CST</td>
	        	<td>VERIFIED_PAYMENT</td>
	        	<td>-29751.5200 EUR</td>
	        	<td>EMPTY</td>
	        </tr>
	        <tr>
	        	<td>11/01/2028</td>
	        	<td>NEW</td>
	        	<td>CST</td>
	        	<td>VERIFIED_RECEIPT</td>
	        	<td>26347.9500 GBP</td>
	        	<td>EMPTY</td>
	        </tr>
	    </table>

	</body>
	
</html>